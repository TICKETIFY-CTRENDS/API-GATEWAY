server:
  port: 5010

spring:
  application:
    name: api-gateway
  data:
    redis:
      host: localhost
      port: 6379
      timeout: 2000ms

  cloud:
    gateway:
      routes:
        # ---------- PUBLIC: Events (must be FIRST) ----------
        - id: event-manager-public
          uri: http://localhost:5000
          predicates:
            - Path=/api/events/**,/api/artists/**,/api/venues/**,/api/business-organizations/**,/api/sponsors/**
            - Method=GET
          filters:
            - RemoveRequestHeader=Authorization
            # Keep public GETs simple (no RL/CircuitBreaker needed)

        - id: event-manager-stripe-webhook
          uri: http://localhost:5000
          predicates:
            - Path=/api/payments/webhook
          filters:
            - RemoveRequestHeader=Authorization

        # ---------- PROTECTED: everything else under /api/** ----------
        - id: event-manager
          uri: http://localhost:5000
          predicates:
            - Path=/api/**
          filters:
            # CircuitBreaker (Resilience4j)
            - name: CircuitBreaker
              args:
                name: eventManagerCB
                fallbackUri: forward:/fallback

            # Redis-backed RequestRateLimiter
            # If Redis isn't running locally, comment this whole block.
#            - name: RequestRateLimiter
#              args:
#                redis-rate-limiter.replenishRate: 5
#                redis-rate-limiter.burstCapacity: 10
#                redis-rate-limiter.requestedTokens: 1

# ======== Resilience4j Configuration ========
resilience4j:
  circuitbreaker:
    instances:
      eventManagerCB:
        registerHealthIndicator: true
        slidingWindowSize: 10
        minimumNumberOfCalls: 5
        failureRateThreshold: 50
        waitDurationInOpenState: 10s
        permittedNumberOfCallsInHalfOpenState: 3
        automaticTransitionFromOpenToHalfOpenEnabled: true

  timelimiter:
    instances:
      eventManagerCB:
        timeoutDuration: 5s
        cancelRunningFuture: true

# ======== Actuator Configuration (monitoring) ========
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,circuitbreakers
  endpoint:
    health:
      enabled: true
    circuitbreakers:
      enabled: true

# ======== Logging ========
logging:
  file:
    name: logs/gateway.log
  level:
    org.springframework.cloud.gateway: DEBUG
    io.github.resilience4j: DEBUG
